<!DOCTYPE html>
<html lang="en">
    <head>
        <title>In-Article Promo Management</title>
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Content-Type" content="text/html;" />
        <link rel='stylesheet' id='knowlton-styles-css'  href='https://assets.digitalfirstmedia.com/prod/static/css/denverpost.css?ver=1.0' type='text/css' media='all' />
        <link rel='stylesheet' id='mason-fonts-css'  href='https://fonts.googleapis.com/css?family=Open%20Sans|Source+Serif+Pro%3A400%2C400italic%2C600%2C600italic%2C700%2C700italic%7CSource+Sans+Pro%3A400%2C400italic%2C600%2C600italic%2C700%2C400italic&#038;ver=4.5.3' type='text/css' media='all' />
        <style type="text/css">
input, textarea { clear: both; }
body { margin: .5em 1em; }
input[type=url],
input[type=email]
{
    border: 1px solid #999;
    border-radius: 0;
    color: #1a1a1a;
    height: 30px;
    padding: .5em .625em;
    transition: border-color .25s linear;
}
p
{
    margin-bottom: 1em;
}
a.x
{
    color:red!important; 
    float: left;
}
        </style>
    <script src="https://npmcdn.com/react@15.3.1/dist/react.js"></script>
    <script src="https://npmcdn.com/react-dom@15.3.1/dist/react-dom.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://npmcdn.com/jquery@3.1.0/dist/jquery.min.js"></script>
    <script src="https://npmcdn.com/remarkable@1.6.2/dist/remarkable.min.js"></script>
    </head>
    <body class="body-copy">
<script type="text/babel">
var Article = React.createClass({
  rawMarkup: function() {
    var md = new Remarkable();
    var rawMarkup = md.render(this.props.children.toString());
    return { __html: rawMarkup };
  },

  handleArticleDelete: function() {
    var article = {};
    article.url = this.props.children;
    article.action = 'delete';
    console.log($(article).serializeArray());
    $.ajax({
      url: 'api.php',
      dataType: 'json',
      type: 'POST',
      data: article,
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        this.setState({});
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  },
  render: function() {
    return (
      <div className="article">
        <h3 className="articleAuthor">
          <a href="#" className="x" id={this.props.url} onClick={this.handleArticleDelete}>x</a> {this.props.url}
        </h3>
        <span dangerouslySetInnerHTML={this.rawMarkup()} />
      </div>
    );
  }
});

var ArticleBox = React.createClass({
  loadArticlesFromServer: function() {
    $.ajax({
      url: this.props.url,
      dataType: 'json',
      cache: false,
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  },
  handleArticleSubmit: function(article) {
    var articles = this.state.data;
    // Optimistically set an id on the new article. It will be replaced by an
    // id generated by the server. In a production application you would likely
    // not use Date.now() for this and would have a more robust system in place.
    article.id = Date.now();
    var newArticles = articles.concat([article]);
    this.setState({data: newArticles});
    $.ajax({
      url: this.props.url,
      dataType: 'json',
      type: 'POST',
      data: article,
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        this.setState({data: articles});
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  },
  getInitialState: function() {
    return {data: []};
  },
  componentDidMount: function() {
    this.loadArticlesFromServer();
    setInterval(this.loadArticlesFromServer, this.props.pollInterval);
  },
  render: function() {
    return (
      <div className="articleBox">
        <h2>Articles</h2>
        <ArticleList data={this.state.data} />
        <ArticleForm onArticleSubmit={this.handleArticleSubmit} />
      </div>
    );
  }
});

var ArticleList = React.createClass({
  render: function() {
    var articleNodes = this.props.data.map(function(article) {
      return (
        <Article author={article.author} key={article.id}>
          {article.url}
        </Article>
      );
    });
    return (
      <div className="articleList">
        {articleNodes}
      </div>
    );
  }
});

var ArticleForm = React.createClass({
  getInitialState: function() {
    return {author: '', text: ''};
  },
  handleURLChange: function(e) {
    this.setState({url: e.target.value});
  },
  handleTextChange: function(e) {
    this.setState({text: e.target.value});
  },
  handleSubmit: function(e) {
    e.preventDefault();
    var url = this.state.url.trim();
    if (!url) {
      return;
    }
    this.props.onArticleSubmit({url: url});
    this.setState({url: ''});
  },
  render: function() {
    return (
      <form className="articleForm" onSubmit={this.handleSubmit}>
        <input
          type="url"
          placeholder="http://..."
          value={this.state.url}
          onChange={this.handleURLChange}
          required
        />
        <input type="submit" value="Add Article" />
      </form>
    );
  }
});

ReactDOM.render(
  <ArticleBox url="api.php" pollInterval={2000} />,
  document.getElementById('content')
);
</script>
        <h1>In-Article Promo Article List Editor</h1>
        <p><strong>Add the articles you'd like to see in the in-article promos</strong>.</p>
        <div id="content"></div>
    </body>
</html>
